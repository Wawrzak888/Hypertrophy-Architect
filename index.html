<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Diety Kulturystycznej</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .toast {
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        input:disabled, select:disabled {
            background-color: #4A5568; /* bg-gray-600 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .suggestions-container {
            position: absolute;
            z-index: 10;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background-color: #2d3748; /* bg-gray-700 */
            border: 1px solid #4a5568; /* border-gray-600 */
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #4a5568; /* bg-gray-600 */
        }
        .meal-content {
            max-height: 1000px; 
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .meal-content.collapsed {
            max-height: 0;
        }
        .meal-header .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .meal-header.collapsed .chevron {
            transform: rotate(-90deg);
        }
        .product-category-header .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .product-category-header.collapsed .chevron {
            transition: transform 0.3s ease-in-out;
        }
        .product-category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        @keyframes pulse-ai {
          0%, 100% {
            opacity: 1;
            transform: scale(1);
          }
          50% {
            opacity: 0.7;
            transform: scale(1.1);
          }
        }
        .ai-pulse-btn {
            animation: pulse-ai 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        #ai-response-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }
        #ai-response-content li {
            margin-bottom: 0.5rem;
        }
        #ai-response-content p {
            margin-bottom: 1rem;
        }
        #ai-response-content strong {
            color: #67E8F9; /* text-cyan-300 */
        }
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .ai-spinner {
          display: inline-block;
          width: 5rem; 
          height: 5rem; 
          border: 6px solid rgba(255, 255, 255, 0.2);
          border-top-color: #22D3EE; /* cyan-400 */
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-cyan-400">Hypertrophy Architect</h1>
            <p class="text-gray-400 mt-2">Zoptymalizuj swoją dietę w oparciu o badania naukowe na kulturystach.</p>
        </header>

        <main class="space-y-8">
            <!-- Sekcja profilu użytkownika -->
            <section id="user-profile" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-cyan-300">Witaj, <span id="user-name-display"></span>!</h2>
                    <div class="flex gap-2">
                         <button id="edit-data-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Zmień dane</button>
                         <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Wyczyść dane</button>
                    </div>
                </div>
            </section>

            <!-- Sekcja danych użytkownika -->
            <section id="user-data" class="bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">1. Wprowadź swoje parametry</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                       <label for="user-name" class="block text-sm font-medium text-gray-300 mb-2">Twoje imię</label>
                       <input type="text" id="user-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. Tomasz">
                    </div>
                    <div>
                        <label for="gender" class="block text-sm font-medium text-gray-300 mb-2">Płeć</label>
                        <select id="gender" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="male">Mężczyzna</option>
                            <option value="female">Kobieta</option>
                        </select>
                    </div>
                    <div>
                        <label for="age" class="block text-sm font-medium text-gray-300 mb-2">Wiek</label>
                        <input type="number" id="age" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. 30">
                    </div>
                     <div>
                        <label for="height" class="block text-sm font-medium text-gray-300 mb-2">Wzrost (cm)</label>
                        <input type="number" id="height" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. 180">
                    </div>
                    <div>
                        <label for="weight" class="block text-sm font-medium text-gray-300 mb-2">Twoja waga (kg)</label>
                        <input type="number" id="weight" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="np. 85">
                    </div>
                    <div>
                        <label for="meal-count" class="block text-sm font-medium text-gray-300 mb-2">Ilość posiłków dziennie</label>
                        <select id="meal-count" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="3">3 posiłki</option>
                            <option value="4" selected>4 posiłki</option>
                            <option value="5">5 posiłków</option>
                            <option value="6">6 posiłków</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="activity" class="block text-sm font-medium text-gray-300 mb-2">Współczynnik aktywności (PAL)</label>
                        <select id="activity" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="1.2">Praca siedząca, brak aktywności</option>
                            <option value="1.4">Praca siedząca + 1-3 lekkie treningi</option>
                            <option value="1.6" selected>Praca siedząca + 3-5 intensywnych treningów</option>
                            <option value="1.8">Praca fizyczna + 3-5 treningów</option>
                            <option value="2.0">Bardzo ciężka praca fizyczna lub codzienne treningi</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                         <label for="goal" class="block text-sm font-medium text-gray-300 mb-2">Cel: Tempo przyrostu masy ciała</label>
                        <select id="goal" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none">
                            <option value="0.25">Ostrożna masa (0.25% na tydzień) - minimalizacja tłuszczu</option>
                            <option value="0.5" selected>Optymalna masa (0.5% na tydzień) - zbalansowany wzrost</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 text-center">
                    <button id="calculate-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">Zapisz i Oblicz</button>
                </div>
            </section>

            <!-- Sekcja wyników -->
            <section id="results" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                 <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">2. Twoje dzienne zapotrzebowanie</h2>
                 <div class="text-center bg-gray-900 p-6 rounded-xl mb-6">
                    <p class="text-gray-400 text-lg">Cel kaloryczny</p>
                    <p id="total-calories" class="text-4xl font-bold text-white">0 kcal</p>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-emerald-900/50 p-4 rounded-lg">
                        <p class="font-bold text-emerald-300">Białko</p>
                        <p id="protein-grams" class="text-2xl font-semibold">0 g</p>
                        <p class="text-sm text-gray-400">(2.0 g/kg m.c.)</p>
                    </div>
                     <div class="bg-amber-900/50 p-4 rounded-lg">
                        <p class="font-bold text-amber-300">Węglowodany</p>
                        <p id="carbs-grams" class="text-2xl font-semibold">0 g</p>
                        <p class="text-sm text-gray-400">(Reszta energii)</p>
                    </div>
                     <div class="bg-rose-900/50 p-4 rounded-lg">
                        <p class="font-bold text-rose-300">Tłuszcze</p>
                        <p id="fat-grams" class="text-2xl font-semibold">0 g</p>
                        <p class="text-sm text-gray-400">(1.0 g/kg m.c.)</p>
                    </div>
                 </div>
                 <div class="mt-6 text-xs text-center text-gray-500">
                    <p>Powyższe makroskładniki są zgodne z zaleceniami ISSN: Białko 1.6-2.2 g/kg, Tłuszcze 0.5-1.5 g/kg, reszta kalorii z węglowodanów.</p>
                 </div>
            </section>
            
            <!-- Sekcja planera diety -->
            <section id="diet-planner" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                 <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-cyan-300 text-center sm:text-left">3. Skomponuj swoją dietę</h2>
                    <div class="flex gap-2">
                        <button id="add-meal-separator-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Nowy Posiłek</button>
                        <button id="clear-day-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm">Wyczyść Dzień</button>
                    </div>
                </div>
                <p class="text-center text-gray-400 -mt-4 mb-6 text-sm">Dodawaj produkty do listy. Użyj przycisku "Nowy Posiłek", aby oddzielić śniadanie, obiad, kolację itd.</p>
                
                <!-- Podsumowanie makro -->
                <div class="bg-gray-900 p-4 rounded-xl mb-6 space-y-3 sticky top-4 z-20">
                    <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Kalorie</span><span class="text-sm" id="current-calories">0 / 0 kcal</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="calories-progress" class="bg-cyan-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                     <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Białko</span><span class="text-sm" id="current-protein">0 / 0 g</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="protein-progress" class="bg-emerald-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                     <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Węglowodany</span><span class="text-sm" id="current-carbs">0 / 0 g</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="carbs-progress" class="bg-amber-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                     <div>
                        <div class="flex justify-between items-baseline mb-1"><span class="font-medium text-gray-300">Tłuszcze</span><span class="text-sm" id="current-fat">0 / 0 g</span></div>
                        <div class="w-full bg-gray-700 rounded-full h-2"><div id="fat-progress" class="bg-rose-400 h-2 rounded-full progress-bar" style="width: 0%"></div></div>
                    </div>
                </div>

                <!-- Dodawanie produktu -->
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="relative flex-grow">
                        <input type="text" id="product-search" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Wyszukaj produkt..." autocomplete="off">
                        <div id="product-suggestions" class="hidden suggestions-container"></div>
                    </div>
                    <input type="number" id="product-amount" class="md:w-32 bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-cyan-500 focus:outline-none" placeholder="Ilość (g)">
                    <button id="add-product-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">Dodaj</button>
                </div>

                <p class="text-center text-gray-500 text-xs -mt-4 mb-4">Wartości makroskładników są orientacyjne i mogą się różnić w zależności od producenta oraz sposobu przygotowania produktu.</p>

                <!-- Przycisk do dodawania własnych produktów -->
                <div class="text-center mb-6 flex flex-wrap justify-center gap-4">
                    <button id="open-composer-btn" class="text-emerald-400 hover:text-emerald-300 text-sm font-medium transition-colors">Skomponuj własny posiłek</button>
                    <button id="open-modal-btn" class="text-cyan-400 hover:text-cyan-300 text-sm font-medium transition-colors">Dodaj prosty produkt</button>
                    <button id="show-product-list-btn" class="text-purple-400 hover:text-purple-300 text-sm font-medium transition-colors">Pokaż listę produktów</button>
                </div>

                <!-- Lista posiłków -->
                <div id="meal-list" class="space-y-4">
                    <p class="text-center text-gray-500">Twoja lista posiłków jest pusta.</p>
                </div>
                <div class="mt-6">
                    <button id="export-pdf-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>Eksportuj Dzienny Plan do PDF</button>
                </div>
            </section>

            <!-- Sekcja Kluczowych Zasad -->
            <section id="key-principles" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">4. Kluczowe Zasady i Strategie</h2>
                <div class="space-y-3 accordion-container">
                    <!-- ... (treść akordeonów bez zmian) ... -->
                </div>
            </section>

             <!-- Sekcja Suplementacji -->
            <section id="supplementation" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <h2 class="text-2xl font-bold text-cyan-300 mb-6 text-center">5. Hierarchia Suplementacji</h2>
                <div class="space-y-3 accordion-container">
                    <!-- ... (treść akordeonów bez zmian) ... -->
                </div>
            </section>

             <!-- Sekcja Nawodnienia -->
            <section id="hydration" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg fade-in">
                <!-- ... (treść sekcji bez zmian) ... -->
            </section>
        </main>

        <!-- Modal do dodawania PROSTEGO produktu -->
        <div id="custom-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <!-- ... (treść modala bez zmian) ... -->
        </div>

        <!-- Modal do KOMPONOWANIA posiłku -->
        <div id="meal-composer-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <!-- ... (treść modala bez zmian) ... -->
        </div>

        <!-- Modal z pełną listą produktów -->
        <div id="product-list-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <!-- ... (treść modala bez zmian) ... -->
        </div>

        <!-- Modal Asystenta AI -->
        <div id="ai-assistant-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-2xl p-6 flex flex-col max-h-[90vh]">
                 <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-4">
                    <h3 class="text-xl font-bold text-cyan-300">Asystent Posiłku AI</h3>
                    <button id="close-ai-modal-btn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="ai-response-container" class="overflow-y-auto space-y-4">
                    <div id="ai-loading-state" class="hidden text-center p-8">
                        <div class="ai-spinner mx-auto mb-6"></div>
                        <p class="text-lg text-gray-400 animate-pulse">Analizuję Twój posiłek...</p>
                    </div>
                    <div id="ai-response-content" class="text-gray-300">
                    </div>
                </div>
            </div>
        </div>


        <div id="toast-container" class="fixed bottom-5 right-5 z-50 space-y-2"></div>

        <footer class="text-center mt-12 text-gray-600 text-sm space-y-1">
            <p>Tomasz Wawrzak &copy; 2025</p>
            <p class="text-xs">Opracowano na podstawie zaleceń wiodących organizacji, takich jak International Society of Sports Nutrition (ISSN) i Instytut Żywności i Żywienia (IŻŻ), oraz metaanaliz badań z zakresu fizjologii hipertrofii.</p>
        </footer>

    </div>

    <script>
        // --- BAZA PRODUKTÓW (na 100g) ---
        const initialFoodProducts = [
            // ... (cała baza produktów bez zmian) ...
            { name: 'Pierś z kurczaka', category: 'Mięsa', calories: 165, protein: 31, fat: 3.6, carbs: 0 },
            { name: 'Pierś z indyka', category: 'Mięsa', calories: 135, protein: 29, carbs: 0, fat: 1.7 },
            { name: 'Schab wieprzowy', category: 'Mięsa', calories: 242, protein: 27, fat: 14, carbs: 0 },
            { name: 'Wołowina (mielona chuda)', category: 'Mięsa', calories: 217, protein: 26, carbs: 0, fat: 12 },
            { name: 'Wołowina (rostbef)', category: 'Mięsa', calories: 155, protein: 28.7, carbs: 0, fat: 3.9 },
            { name: 'Wołowina (udziec)', category: 'Mięsa', calories: 201, protein: 28, fat: 9, carbs: 0 },
            { name: 'Boczek wędzony', category: 'Wędliny', calories: 510, protein: 15, fat: 50, carbs: 0 },
            { name: 'Kabanosy (wieprzowe)', category: 'Wędliny', calories: 490, protein: 28, carbs: 1, fat: 42 },
            { name: 'Kiełbasa śląska', category: 'Wędliny', calories: 280, protein: 14, fat: 25, carbs: 1.5 },
            { name: 'Kiełbasa żywiecka', category: 'Wędliny', calories: 325, protein: 18, carbs: 1, fat: 28 },
            { name: 'Polędwica sopocka', category: 'Wędliny', calories: 160, protein: 19, fat: 9, carbs: 1 },
            { name: 'Szynka gotowana', category: 'Wędliny', calories: 128, protein: 20, carbs: 1, fat: 5 },
            { name: 'Dorsz', category: 'Ryby', calories: 82, protein: 17.8, carbs: 0, fat: 0.7 },
            { name: 'Halibut', category: 'Ryby', calories: 110, protein: 21, carbs: 0, fat: 2.5 },
            { name: 'Łosoś świeży', category: 'Ryby', calories: 208, protein: 20, fat: 13, carbs: 0 },
            { name: 'Makrela wędzona', category: 'Ryby', calories: 355, protein: 20.7, carbs: 0, fat: 30.5 },
            { name: 'Mintaj', category: 'Ryby', calories: 81, protein: 17.5, carbs: 0, fat: 1 },
            { name: 'Pstrąg tęczowy', category: 'Ryby', calories: 140, protein: 21, carbs: 0, fat: 6 },
            { name: 'Sardynki w oleju', category: 'Ryby', calories: 208, protein: 25, carbs: 0, fat: 11 },
            { name: 'Śledź w oleju', category: 'Ryby', calories: 300, protein: 16, carbs: 0, fat: 25 },
            { name: 'Tuńczyk w wodzie', category: 'Ryby', calories: 116, protein: 25.5, carbs: 0, fat: 0.8 },
            { name: 'Jajko kurze', category: 'Nabiał i Jaja', calories: 155, protein: 12.6, carbs: 1.1, fat: 10.6, unit: 'szt', avgWeight: 55 },
            { name: 'Jogurt grecki', category: 'Nabiał i Jaja', calories: 97, protein: 10, carbs: 3.6, fat: 5 },
            { name: 'Jogurt naturalny', category: 'Nabiał i Jaja', calories: 61, protein: 4.3, fat: 3, carbs: 6.2 },
            { name: 'Kefir 2%', category: 'Nabiał i Jaja', calories: 51, protein: 3.4, fat: 2, carbs: 4.7 },
            { name: 'Mleko 3.2%', category: 'Nabiał i Jaja', calories: 61, protein: 3.2, fat: 3.2, carbs: 4.8 },
            { name: 'Ser mozzarella light', category: 'Nabiał i Jaja', calories: 171, protein: 25, carbs: 1, fat: 7 },
            { name: 'Ser żółty (Gouda)', category: 'Nabiał i Jaja', calories: 356, protein: 25, carbs: 2.2, fat: 27 },
            { name: 'Serek wiejski', category: 'Nabiał i Jaja', calories: 97, protein: 11, carbs: 2.7, fat: 4.3 },
            { name: 'Skyr naturalny', category: 'Nabiał i Jaja', calories: 63, protein: 12, carbs: 4, fat: 0.2 },
            { name: 'Śmietana 18%', category: 'Nabiał i Jaja', calories: 186, protein: 2.8, fat: 18, carbs: 3.7 },
            { name: 'Twaróg chudy', category: 'Nabiał i Jaja', calories: 98, protein: 19.8, carbs: 3.5, fat: 0.5 },
            { name: 'Twaróg półtłusty', category: 'Nabiał i Jaja', calories: 133, protein: 18.7, carbs: 3.7, fat: 5 },
            { name: 'Twaróg tłusty', category: 'Nabiał i Jaja', calories: 175, protein: 17, carbs: 3, fat: 11 },
            { name: 'Gainer', category: 'Odżywki', calories: 380, protein: 20, carbs: 70, fat: 2 },
            { name: 'Odżywka białkowa', category: 'Odżywki', calories: 380, protein: 80, carbs: 5, fat: 4 },
            { name: 'Chleb biały (pszenny)', category: 'Produkty Zbożowe', calories: 265, protein: 9, carbs: 50, fat: 3.2 },
            { name: 'Chleb pełnoziarnisty', category: 'Produkty Zbożowe', calories: 250, protein: 13, carbs: 43, fat: 3 },
            { name: 'Chleb pszenny', category: 'Produkty Zbożowe', calories: 265, protein: 9, fat: 3.2, carbs: 49 },
            { name: 'Chleb żytni razowy', category: 'Produkty Zbożowe', calories: 259, protein: 8.5, fat: 3.3, carbs: 48 },
            { name: 'Kasza gryczana', category: 'Produkty Zbożowe', calories: 343, protein: 13.3, carbs: 71.5, fat: 3.4 },
            { name: 'Kasza jaglana', category: 'Produkty Zbożowe', calories: 378, protein: 11, carbs: 73, fat: 4.2 },
            { name: 'Komosa ryżowa (Quinoa)', category: 'Produkty Zbożowe', calories: 368, protein: 14.1, carbs: 64.2, fat: 6.1 },
            { name: 'Makaron jajeczny', category: 'Produkty Zbożowe', calories: 371, protein: 13, fat: 2.8, carbs: 74 },
            { name: 'Makaron pełnoziarnisty', category: 'Produkty Zbożowe', calories: 348, protein: 13.9, carbs: 73.3, fat: 2.8 },
            { name: 'Płatki owsiane', category: 'Produkty Zbożowe', calories: 389, protein: 16.9, carbs: 66.3, fat: 6.9 },
            { name: 'Ryż basmati', category: 'Produkty Zbożowe', calories: 349, protein: 9.7, carbs: 75, fat: 0.4 },
            { name: 'Ryż biały', category: 'Produkty Zbożowe', calories: 365, protein: 7.1, carbs: 79.9, fat: 0.7 },
            { name: 'Ryż brązowy', category: 'Produkty Zbożowe', calories: 370, protein: 7.9, carbs: 77.2, fat: 2.9 },
            { name: 'Ciecierzyca (sucha)', category: 'Rośliny strączkowe', calories: 364, protein: 19, carbs: 61, fat: 6 },
            { name: 'Fasola czerwona (konserwowa)', category: 'Rośliny strączkowe', calories: 127, protein: 8.7, carbs: 22.8, fat: 0.5 },
            { name: 'Groch (łuskany, suchy)', category: 'Rośliny strączkowe', calories: 341, protein: 24.5, carbs: 60, fat: 1.2 },
            { name: 'Soczewica czerwona (sucha)', category: 'Rośliny strączkowe', calories: 353, protein: 25.8, carbs: 60, fat: 1.1 },
            { name: 'Awokado', category: 'Warzywa i Owoce', calories: 160, protein: 2, fat: 15, carbs: 9 },
            { name: 'Banan', category: 'Warzywa i Owoce', calories: 89, protein: 1.1, fat: 0.3, carbs: 23 },
            { name: 'Bataty', category: 'Warzywa i Owoce', calories: 86, protein: 1.6, carbs: 20.1, fat: 0.1 },
            { name: 'Brokuł', category: 'Warzywa i Owoce', calories: 34, protein: 2.8, fat: 0.4, carbs: 7 },
            { name: 'Cebula', category: 'Warzywa i Owoce', calories: 40, protein: 1.1, fat: 0.1, carbs: 9 },
            { name: 'Jabłko', category: 'Warzywa i Owoce', calories: 52, protein: 0.3, fat: 0.2, carbs: 14 },
            { name: 'Marchew', category: 'Warzywa i Owoce', calories: 41, protein: 0.9, fat: 0.2, carbs: 10 },
            { name: 'Ogórek', category: 'Warzywa i Owoce', calories: 15, protein: 0.7, fat: 0.1, carbs: 3.6 },
            { name: 'Papryka czerwona', category: 'Warzywa i Owoce', calories: 31, protein: 1, fat: 0.3, carbs: 6 },
            { name: 'Pomarańcza', category: 'Warzywa i Owoce', calories: 47, protein: 0.9, fat: 0.1, carbs: 12 },
            { name: 'Pomidor', category: 'Warzywa i Owoce', calories: 18, protein: 0.9, fat: 0.2, carbs: 3.9 },
            { name: 'Sałata lodowa', category: 'Warzywa i Owoce', calories: 14, protein: 0.9, fat: 0.1, carbs: 3 },
            { name: 'Szpinak', category: 'Warzywa i Owoce', calories: 23, protein: 2.9, carbs: 3.6, fat: 0.4 },
            { name: 'Truskawki', category: 'Warzywa i Owoce', calories: 32, protein: 0.7, fat: 0.3, carbs: 8 },
            { name: 'Winogrona', category: 'Warzywa i Owoce', calories: 69, protein: 0.7, fat: 0.2, carbs: 18 },
            { name: 'Ziemniaki', category: 'Warzywa i Owoce', calories: 77, protein: 2, fat: 0.1, carbs: 17 },
            { name: 'Masło 82%', category: 'Tłuszcze', calories: 740, protein: 1, carbs: 1, fat: 82 },
            { name: 'Masło orzechowe', category: 'Tłuszcze', calories: 597, protein: 22.5, carbs: 22.3, fat: 51.1 },
            { name: 'Migdały', category: 'Tłuszcze', calories: 579, protein: 21.2, carbs: 21.6, fat: 49.9 },
            { name: 'Nasiona słonecznika', category: 'Tłuszcze', calories: 584, protein: 20.8, carbs: 20, fat: 51.5 },
            { name: 'Olej lniany', category: 'Tłuszcze', calories: 884, protein: 0, carbs: 0, fat: 100 },
            { name: 'Oliwa z oliwek', category: 'Tłuszcze', calories: 884, protein: 0, carbs: 0, fat: 100 },
            { name: 'Orzechy włoskie', category: 'Tłuszcze', calories: 654, protein: 15.2, carbs: 13.7, fat: 65.2 },
            { name: 'Pestki dyni', category: 'Tłuszcze', calories: 559, protein: 30.2, carbs: 10.7, fat: 49.1 },
        ];
        
        let foodProducts = [...initialFoodProducts];
        let customProducts = [];

        // --- ZMIENNE GLOBALNE ---
        let dietGoals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
        let dailyPlan = [];
        let currentlySelectedProduct = null;
        let sortedFoodProducts = [...foodProducts].sort((a, b) => a.name.localeCompare(b.name));
        let activeMealIdForAdding = null;
        let activeComposerInput = null;

        // --- ELEMENTY DOM (TYLKO DEKLARACJE) ---
        let calculateBtn, editDataBtn, clearDataBtn, addProductBtn, productSearchInput, 
            productSuggestionsContainer, resultsSection, plannerSection, principlesSection, 
            supplementationSection, hydrationSection, exportPdfBtn, clearDayBtn, 
            addMealSeparatorBtn, userNameInput, userNameDisplay, allDataInputs, 
            openModalBtn, closeModalBtn, customProductModal, customProductForm, 
            simpleProductModalTitle, simpleProductSubmitBtn, originalProductNameInput, 
            openComposerBtn, closeComposerBtn, mealComposerModal, composerIngredientsContainer, 
            composerSummaryDiv, saveComposedMealBtn, showProductListBtn, productListModal, 
            closeProductListBtn, modalProductListContent, aiAssistantModal, closeAiModalBtn, 
            aiResponseContainer, aiLoadingState, aiResponseContent;

        // --- FUNKCJE ---
        function getDailyPlanKey() {
            const today = new Date();
            return `dailyPlan_${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }
        function saveDailyPlan() {
            localStorage.setItem(getDailyPlanKey(), JSON.stringify(dailyPlan));
        }
        function loadDailyPlan() {
            const savedPlan = localStorage.getItem(getDailyPlanKey());
            if (savedPlan) {
                try {
                    dailyPlan = JSON.parse(savedPlan);
                } catch (e) {
                    console.error("Błąd parsowania dailyPlan z localStorage:", e);
                    dailyPlan = [];
                    localStorage.removeItem(getDailyPlanKey());
                }
            } else {
                dailyPlan = [];
            }
        }
        function clearDailyPlan() {
            dailyPlan = [];
            saveDailyPlan();
            renderMealList();
            updateSummary();
            showToast("Dzisiejszy plan został wyczyszczony.", 'success');
        }
        function addMealSeparator() {
            if (dailyPlan.length === 0 || dailyPlan[dailyPlan.length - 1].type !== 'separator') {
                 const mealCount = dailyPlan.filter(item => item.type === 'separator').length + 1;
                 const separator = {
                    id: Date.now(),
                    type: 'separator',
                    name: `Posiłek ${mealCount}`
                };
                dailyPlan.push(separator);
                activeMealIdForAdding = separator.id; 
                saveDailyPlan();
                renderMealList();
            } else {
                showToast('Nowy posiłek został już rozpoczęty.');
            }
        }
        function clearUserData() {
            localStorage.removeItem('hypertrophyCalcUser');
            localStorage.removeItem(getDailyPlanKey());
            dailyPlan = [];
            dietGoals = { calories: 0, protein: 0, carbs: 0, fat: 0 };
            allDataInputs.forEach(input => {
                if(input.type === 'select-one') {
                     if(input.id === 'activity') input.value = '1.6';
                     else if(input.id === 'goal') input.value = '0.5';
                     else if(input.id === 'meal-count') input.value = '4'; 
                     else input.selectedIndex = 0;
                } else {
                    input.value = '';
                }
            });
            document.getElementById('user-data').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('hidden');
            resultsSection.classList.add('hidden');
            plannerSection.classList.add('hidden');
            principlesSection.classList.add('hidden');
            supplementationSection.classList.add('hidden');
            hydrationSection.classList.add('hidden');
            renderMealList();
            showToast("Wszystkie dane zostały wyczyszczone.", 'success');
        }
        function saveUserData() {
            const userData = {
                name: document.getElementById('user-name').value,
                gender: document.getElementById('gender').value,
                age: document.getElementById('age').value,
                height: document.getElementById('height').value,
                weight: document.getElementById('weight').value,
                activity: document.getElementById('activity').value,
                goal: document.getElementById('goal').value,
                mealCount: document.getElementById('meal-count').value 
            };
            localStorage.setItem('hypertrophyCalcUser', JSON.stringify(userData));
        }
        function loadUserData() {
            const savedData = localStorage.getItem('hypertrophyCalcUser');
            if (savedData) {
                const userData = JSON.parse(savedData);
                userNameInput.value = userData.name || '';
                document.getElementById('gender').value = userData.gender || 'male';
                document.getElementById('age').value = userData.age || '';
                document.getElementById('height').value = userData.height || '';
                document.getElementById('weight').value = userData.weight || '';
                document.getElementById('activity').value = userData.activity || '1.6';
                document.getElementById('goal').value = userData.goal || '0.5';
                document.getElementById('meal-count').value = userData.mealCount || '4'; 
                if(userData.name && userData.age && userData.height && userData.weight) {
                    calculateNeeds();
                }
            }
        }
        function showToast(message, type = 'error') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-emerald-500';
            toast.className = `toast p-4 rounded-lg shadow-lg text-white font-medium ${bgColor}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        function calculateNeeds() {
            const userName = userNameInput.value.trim();
            const gender = document.getElementById('gender').value;
            const age = parseFloat(document.getElementById('age').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityFactor = parseFloat(document.getElementById('activity').value);
            const goalFactor = parseFloat(document.getElementById('goal').value);
            const mealCount = parseInt(document.getElementById('meal-count').value, 10);
            if (!userName) {
                showToast("Proszę podać swoje imię.");
                return;
            }
            if (!age || age <= 0) {
                showToast("Proszę podać prawidłowy wiek.");
                return;
            }
            if (!height || height <= 0) {
                showToast("Proszę podać prawidłowy wzrost.");
                return;
            }
            if (!weight || weight <= 0) {
                showToast("Proszę podać prawidłową wagę.");
                return;
            }
            if (!mealCount || mealCount <= 0) {
                showToast("Proszę podać prawidłową liczbę posiłków.");
                return;
            }
            saveUserData();
            let bmr;
            if (gender === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
            const maintenanceCalories = bmr * activityFactor;
            const weeklyGainKg = weight * (goalFactor / 100);
            const dailySurplus = (weeklyGainKg * 7700) / 7; 
            const targetCalories = maintenanceCalories + dailySurplus;
            const proteinGrams = weight * 2.0;
            const proteinCalories = proteinGrams * 4;
            const fatGrams = weight * 1.0;
            const fatCalories = fatGrams * 9;
            const remainingCalories = targetCalories - proteinCalories - fatCalories;
            const carbsGrams = remainingCalories / 4;
            dietGoals = {
                calories: Math.round(targetCalories),
                protein: Math.round(proteinGrams),
                carbs: Math.round(carbsGrams),
                fat: Math.round(fatGrams)
            };
            displayResults();
            updateSummary();
            document.getElementById('user-data').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            userNameDisplay.textContent = userName;
            resultsSection.classList.remove('hidden');
            plannerSection.classList.remove('hidden');
            principlesSection.classList.remove('hidden');
            supplementationSection.classList.remove('hidden');
            hydrationSection.classList.remove('hidden');
        }
        function displayResults() {
            document.getElementById('total-calories').textContent = `${dietGoals.calories} kcal`;
            document.getElementById('protein-grams').textContent = `${dietGoals.protein} g`;
            document.getElementById('carbs-grams').textContent = `${dietGoals.carbs} g`;
            document.getElementById('fat-grams').textContent = `${dietGoals.fat} g`;
        }
        function addProductToPlan() {
            const amount = parseFloat(document.getElementById('product-amount').value);
            if (!currentlySelectedProduct || productSearchInput.value !== currentlySelectedProduct.name) {
                showToast("Wybierz produkt z listy sugestii.");
                return;
            }
            if (!amount || amount <= 0) {
                showToast("Podaj prawidłową ilość.");
                return;
            }
            const hasMeals = dailyPlan.some(item => item.type === 'separator');
            if (!hasMeals) {
                addMealSeparator();
            }
            const product = currentlySelectedProduct;
            let calculatedAmountInGrams = amount;
            let displayUnit = 'g';
            let factor; 
            if (product.isComposed) {
                displayUnit = 'porcji';
                factor = amount;
            } else if (product.unit === 'szt' && product.avgWeight) {
                calculatedAmountInGrams = amount * product.avgWeight;
                displayUnit = 'szt';
                factor = calculatedAmountInGrams / 100;
            } else {
                factor = calculatedAmountInGrams / 100;
            }
            const mealItem = {
                id: Date.now(),
                type: 'product',
                name: product.name,
                amount: amount,
                displayUnit: displayUnit,
                calories: product.calories * factor,
                protein: product.protein * factor,
                carbs: product.carbs * factor,
                fat: product.fat * factor
            };
            let mealToAddToId = activeMealIdForAdding;
            if (!mealToAddToId) {
                const lastSeparator = dailyPlan.filter(item => item.type === 'separator').pop();
                if (lastSeparator) {
                    mealToAddToId = lastSeparator.id;
                    activeMealIdForAdding = mealToAddToId;
                }
            }
            if (mealToAddToId) {
                const separatorIndex = dailyPlan.findIndex(item => item.id === mealToAddToId);
                if (separatorIndex !== -1) {
                    let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
                    if (nextSeparatorIndex === -1) {
                        dailyPlan.push(mealItem);
                    } else {
                        dailyPlan.splice(nextSeparatorIndex, 0, mealItem);
                    }
                } else {
                    dailyPlan.push(mealItem);
                }
            } else {
                dailyPlan.push(mealItem);
            }
            saveDailyPlan();
            renderMealList();
            updateSummary();
            productSearchInput.value = '';
            currentlySelectedProduct = null;
            document.getElementById('product-amount').value = '';
            document.getElementById('product-amount').placeholder = 'Ilość (g)';
        }
        function calculateMealSummary(products) {
            return products.reduce((acc, item) => {
                acc.calories += item.calories;
                acc.protein += item.protein;
                acc.carbs += item.carbs;
                acc.fat += item.fat;
                return acc;
            }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
        }
        function renderMealList() {
            const mealListDiv = document.getElementById('meal-list');
            mealListDiv.innerHTML = '';
            if (dailyPlan.length === 0) {
                mealListDiv.innerHTML = '<p class="text-center text-gray-500">Twoja lista posiłków jest pusta.</p>';
                exportPdfBtn.disabled = true;
                return;
            }
            exportPdfBtn.disabled = false;
            const meals = [];
            let currentMeal = null;
            dailyPlan.forEach(item => {
                if (item.type === 'separator') {
                    if (currentMeal) {
                        meals.push(currentMeal);
                    }
                    currentMeal = { separator: item, products: [] };
                } else if (item.type === 'product' && currentMeal) {
                    currentMeal.products.push(item);
                }
            });
            if (currentMeal) {
                meals.push(currentMeal);
            }
            meals.forEach((meal, index) => {
                const mealContainer = document.createElement('div');
                mealContainer.className = 'bg-gray-700/50 rounded-lg overflow-hidden fade-in';
                mealContainer.dataset.mealContainerId = meal.separator.id;
                if (meal.separator.id === activeMealIdForAdding) {
                    mealContainer.style.boxShadow = '0 0 0 2px #22D3EE';
                }
                const header = document.createElement('div');
                header.className = 'meal-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-700 transition-colors';
                header.dataset.targetId = `meal-content-${meal.separator.id}`;
                const mealSummary = calculateMealSummary(meal.products);
                const mealTotalCalories = mealSummary.calories;
                const proteinCal = mealSummary.protein * 4;
                const carbsCal = mealSummary.carbs * 4;
                const fatCal = mealSummary.fat * 9;
                const proteinPercent = mealTotalCalories > 0 ? (proteinCal / mealTotalCalories) * 100 : 0;
                const carbsPercent = mealTotalCalories > 0 ? (carbsCal / mealTotalCalories) * 100 : 0;
                const fatPercent = mealTotalCalories > 0 ? (fatCal / mealTotalCalories) * 100 : 0;
                const mealName = meal.separator.name || `Posiłek ${index + 1}`;
                header.innerHTML = `
                    <div class="flex items-center gap-3 flex-grow mr-2" style="min-width: 0;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="chevron h-5 w-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                        <input type="text" value="${mealName}" data-id="${meal.separator.id}" class="meal-name-input font-bold text-green-400 bg-transparent border-0 focus:ring-1 focus:ring-green-500 focus:outline-none w-full p-1 rounded-md" placeholder="Nazwa posiłku...">
                    </div>
                    <div class="flex items-center gap-4 flex-shrink-0">
                        <div class="hidden sm:block space-y-1" style="width: 200px;">
                            <p class="text-xs text-gray-400">
                                ${mealSummary.calories.toFixed(0)} kcal | B: ${mealSummary.protein.toFixed(1)}g | W: ${mealSummary.carbs.toFixed(1)}g | T: ${mealSummary.fat.toFixed(1)}g
                            </p>
                            <div class="w-full bg-gray-600 rounded-full h-1.5 flex" title="Podział makro w posiłku (B: zielony, W: żółty, T: czerwony)">
                                <div class="bg-emerald-400 h-1.5 ${proteinPercent > 0 && (carbsPercent > 0 || fatPercent > 0) ? 'rounded-l-full' : 'rounded-full'}" style="width: ${proteinPercent}%"></div>
                                <div class="bg-amber-400 h-1.5 ${carbsPercent > 0 && fatPercent > 0 ? '' : (proteinPercent > 0 ? 'rounded-r-full' : 'rounded-full')}" style="width: ${carbsPercent}%"></div>
                                <div class="bg-rose-400 h-1.5 ${fatPercent > 0 ? 'rounded-r-full' : ''}" style="width: ${fatPercent}%"></div>
                            </div>
                        </div>
                        <button data-id="${meal.separator.id}" class="ai-meal-btn text-cyan-400 hover:text-cyan-300 z-10 p-1 ai-pulse-btn" title="Asystent AI dla tego posiłku">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                            </svg>
                        </button>
                        <button data-id="${meal.separator.id}" class="remove-meal-btn text-red-400 hover:text-red-500 z-10 p-1">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                `;
                const content = document.createElement('div');
                content.id = `meal-content-${meal.separator.id}`;
                content.className = 'meal-content space-y-2 px-4 pb-4';
                if (meal.products.length === 0) {
                    content.innerHTML = `<p class="text-sm text-center text-gray-500 py-2">Ten posiłek jest pusty.</p>`;
                } else {
                    meal.products.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'bg-gray-700 p-3 rounded-lg flex items-center justify-between';
                        const displayAmount = item.amount === 0 ? '' : item.amount;
                        const displayCalories = item.amount === 0 ? 0 : item.calories;
                        const displayProtein = item.amount === 0 ? 0 : item.protein;
                        const displayCarbs = item.amount === 0 ? 0 : item.carbs;
                        const displayFat = item.amount === 0 ? 0 : item.fat;
                        itemDiv.innerHTML = `
                            <div class="flex-grow">
                                <p class="font-semibold text-white">${item.name}</p>
                                <p class="text-xs text-gray-400 macros-display" data-id="${item.id}">
                                    Kcal: ${displayCalories.toFixed(0)} | B: ${displayProtein.toFixed(1)}g | W: ${displayCarbs.toFixed(1)}g | T: ${displayFat.toFixed(1)}g
                                </p>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="number" value="${displayAmount}" data-id="${item.id}" class="edit-amount-input w-20 bg-gray-800 border border-gray-600 rounded-md p-1 text-center text-white focus:ring-1 focus:ring-cyan-500 focus:outline-none">
                                <span class="text-gray-400 text-sm">${item.displayUnit || 'g'}</span>
                                <button data-id="${item.id}" class="remove-item-btn text-red-400 hover:text-red-500 text-2xl leading-none">&times;</button>
                            </div>
                        `;
                        content.appendChild(itemDiv);
                    });
                }
                const isCollapsedByDefault = index < meals.length - 1;
                if (isCollapsedByDefault) {
                    header.classList.add('collapsed');
                    content.classList.add('collapsed');
                }
                mealContainer.appendChild(header);
                mealContainer.appendChild(content);
                mealListDiv.appendChild(mealContainer);
            });
        }
        function updateSummary() {
            const totals = dailyPlan
                .filter(item => item.type === 'product')
                .reduce((acc, item) => {
                    acc.calories += item.calories;
                    acc.protein += item.protein;
                    acc.carbs += item.carbs;
                    acc.fat += item.fat;
                    return acc;
                }, { calories: 0, protein: 0, carbs: 0, fat: 0 });
            const updateField = (name, total, goal, unit) => {
                const currentEl = document.getElementById(`current-${name}`);
                const progressEl = document.getElementById(`${name}-progress`);
                if (!currentEl || !progressEl) return;
                currentEl.textContent = `${total.toFixed(0)} / ${goal} ${unit}`;
                const percentage = goal > 0 ? (total / goal) * 100 : 0;
                progressEl.style.width = `${Math.min(percentage, 100)}%`;
            };
            updateField('calories', totals.calories, dietGoals.calories, 'kcal');
            updateField('protein', totals.protein, dietGoals.protein, 'g');
            updateField('carbs', totals.carbs, dietGoals.carbs, 'g');
            updateField('fat', totals.fat, dietGoals.fat, 'g');
        }
        function handleMealListClick(e) {
            if (e.target.classList.contains('meal-name-input')) {
                return;
            }
            const removeItemBtn = e.target.closest('.remove-item-btn');
            if (removeItemBtn) {
                const itemId = parseInt(removeItemBtn.dataset.id);
                dailyPlan = dailyPlan.filter(item => item.id !== itemId);
                saveDailyPlan();
                renderMealList();
                updateSummary();
                return;
            }
            const aiMealBtn = e.target.closest('.ai-meal-btn');
            if (aiMealBtn) {
                e.stopPropagation(); 
                const separatorId = parseInt(aiMealBtn.dataset.id);
                getMealAnalysis(separatorId);
                return;
            }
            const removeMealBtn = e.target.closest('.remove-meal-btn');
            if(removeMealBtn) {
                const separatorId = parseInt(removeMealBtn.dataset.id);
                const separatorIndex = dailyPlan.findIndex(item => item.id === separatorId);
                if (separatorIndex !== -1) {
                    let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
                    if (nextSeparatorIndex === -1) {
                        nextSeparatorIndex = dailyPlan.length;
                    }
                    dailyPlan.splice(separatorIndex, nextSeparatorIndex - separatorIndex);
                    if (activeMealIdForAdding === separatorId) {
                        activeMealIdForAdding = null;
                        const lastSeparator = dailyPlan.filter(item => item.type === 'separator').pop();
                        if (lastSeparator) {
                            activeMealIdForAdding = lastSeparator.id;
                        }
                    }
                    saveDailyPlan();
                    renderMealList();
                    updateSummary();
                }
                return;
            }
            const mealHeader = e.target.closest('.meal-header');
            if(mealHeader) {
                const contentId = mealHeader.dataset.targetId;
                const content = document.getElementById(contentId);
                if (content) {
                    const mealId = parseInt(mealHeader.querySelector('.meal-name-input').dataset.id, 10);
                    if (content.classList.contains('collapsed')) {
                        activeMealIdForAdding = mealId;
                    }
                    document.querySelectorAll('[data-meal-container-id]').forEach(el => {
                        el.style.boxShadow = 'none';
                    });
                    if (activeMealIdForAdding) {
                        const activeContainer = document.querySelector(`[data-meal-container-id="${activeMealIdForAdding}"]`);
                        if (activeContainer) {
                            activeContainer.style.boxShadow = '0 0 0 2px #22D3EE';
                        }
                    }
                    mealHeader.classList.toggle('collapsed');
                    content.classList.toggle('collapsed');
                }
            }
        }
        function handleMealNameChange(e) {
            if (!e.target.classList.contains('meal-name-input')) return;
            const separatorId = parseInt(e.target.dataset.id);
            const newName = e.target.value;
            const itemIndex = dailyPlan.findIndex(item => item.id === separatorId);
            if (itemIndex !== -1) {
                dailyPlan[itemIndex].name = newName;
                saveDailyPlan();
            }
        }
        function handleAmountChange(e) {
            if (!e.target.classList.contains('edit-amount-input')) return;
            const itemId = parseInt(e.target.dataset.id);
            const newAmount = parseFloat(e.target.value);
            const itemIndex = dailyPlan.findIndex(item => item.id === itemId);
            if (itemIndex === -1) {
                 return;
            }
            if (isNaN(newAmount) || newAmount < 0) {
                const itemToUpdate = dailyPlan[itemIndex];
                itemToUpdate.amount = 0;
                itemToUpdate.calories = 0;
                itemToUpdate.protein = 0;
                itemToUpdate.carbs = 0;
                itemToUpdate.fat = 0;
                const macrosDisplay = document.querySelector(`.macros-display[data-id="${itemId}"]`);
                if (macrosDisplay) {
                    macrosDisplay.innerHTML = `Kcal: 0 | B: 0.0g | W: 0.0g | T: 0.0g`;
                }
                saveDailyPlan();
                updateSummary();
                updateMealHeaderSummary(e.target);
                return;
            }
            const itemToUpdate = dailyPlan[itemIndex];
            const originalProduct = foodProducts.find(p => p.name === itemToUpdate.name);
            if (!originalProduct) {
                itemToUpdate.amount = newAmount;
                itemToUpdate.calories = 0;
                itemToUpdate.protein = 0;
                itemToUpdate.carbs = 0;
                itemToUpdate.fat = 0;
                const macrosDisplay = document.querySelector(`.macros-display[data-id="${itemId}"]`);
                if (macrosDisplay) {
                    macrosDisplay.innerHTML = `<span class="text-red-400">Produkt usunięty z bazy</span>`;
                }
                saveDailyPlan();
                updateSummary();
                updateMealHeaderSummary(e.target);
                return; 
            }
            itemToUpdate.amount = newAmount;
            let factor; 
            if (originalProduct.isComposed) { 
                factor = newAmount; 
            } else {
                let calculatedAmountInGrams = newAmount;
                if (originalProduct.unit === 'szt' && originalProduct.avgWeight) {
                    calculatedAmountInGrams = newAmount * originalProduct.avgWeight;
                }
                factor = calculatedAmountInGrams / 100;
            }
            itemToUpdate.calories = originalProduct.calories * factor;
            itemToUpdate.protein = originalProduct.protein * factor;
            itemToUpdate.carbs = originalProduct.carbs * factor;
            itemToUpdate.fat = originalProduct.fat * factor;
            const macrosDisplay = document.querySelector(`.macros-display[data-id="${itemId}"]`);
            if (macrosDisplay) {
                macrosDisplay.innerHTML = `Kcal: ${itemToUpdate.calories.toFixed(0)} | B: ${itemToUpdate.protein.toFixed(1)}g | W: ${itemToUpdate.carbs.toFixed(1)}g | T: ${itemToUpdate.fat.toFixed(1)}g`;
            }
            saveDailyPlan();
            updateSummary();
            updateMealHeaderSummary(e.target);
        }
        function updateMealHeaderSummary(targetElement) {
            const mealContainer = targetElement.closest('[data-meal-container-id]');
            if (mealContainer) {
                const mealHeader = mealContainer.querySelector('.meal-header');
                if (mealHeader) {
                    const separatorId = parseInt(mealHeader.querySelector('.remove-meal-btn').dataset.id, 10);
                    const separatorIndex = dailyPlan.findIndex(item => item.id === separatorId);
                    if (separatorIndex !== -1) {
                         let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
                         if (nextSeparatorIndex === -1) {
                             nextSeparatorIndex = dailyPlan.length;
                         }
                         const mealProducts = dailyPlan.slice(separatorIndex + 1, nextSeparatorIndex).filter(item => item.type === 'product');
                         const summary = calculateMealSummary(mealProducts);
                         const summaryEl = mealHeader.querySelector('.text-xs');
                         if (summaryEl) {
                             summaryEl.innerHTML = `${summary.calories.toFixed(0)} kcal | B: ${summary.protein.toFixed(1)}g | W: ${summary.carbs.toFixed(1)}g | T: ${summary.fat.toFixed(1)}g`;
                         }
                        const mealTotalCalories = summary.calories;
                        const proteinCal = summary.protein * 4;
                        const carbsCal = summary.carbs * 4;
                        const fatCal = summary.fat * 9;
                        const proteinPercent = mealTotalCalories > 0 ? (proteinCal / mealTotalCalories) * 100 : 0;
                        const carbsPercent = mealTotalCalories > 0 ? (carbsCal / mealTotalCalories) * 100 : 0;
                        const fatPercent = mealTotalCalories > 0 ? (fatCal / mealTotalCalories) * 100 : 0;
                        const pBar = mealHeader.querySelector('.bg-emerald-400');
                        const cBar = mealHeader.querySelector('.bg-amber-400');
                        const fBar = mealHeader.querySelector('.bg-rose-400');
                        if(pBar && cBar && fBar) {
                            pBar.style.width = `${proteinPercent}%`;
                            cBar.style.width = `${carbsPercent}%`;
                            fBar.style.width = `${fatPercent}%`;
                            pBar.className = `bg-emerald-400 h-1.5 ${proteinPercent > 0 && (carbsPercent > 0 || fatPercent > 0) ? 'rounded-l-full' : 'rounded-full'}`;
                            cBar.className = `bg-amber-400 h-1.5 ${carbsPercent > 0 && fatPercent > 0 ? '' : (proteinPercent > 0 ? 'rounded-r-full' : 'rounded-full')}`;
                            fBar.className = `bg-rose-400 h-1.5 ${fatPercent > 0 ? 'rounded-r-full' : ''}`;
                        }
                    }
                }
            }
        }
        function handleAccordionClick(e) {
            // ... (bez zmian) ...
        }
        function saveCustomProducts() {
            // ... (bez zmian) ...
        }
        function loadCustomProducts() {
            // ... (bez zmian) ...
        }
        function updateSortedProducts() {
            // ... (bez zmian) ...
        }
        function populateCategoryDropdown() {
            // ... (bez zmian) ...
        }
        function resetSimpleProductModal() {
            // ... (bez zmian) ...
        }
        function openSimpleProductModalForEdit(product) {
            // ... (bez zmian) ...
        }
        function updateDailyPlanAfterEdit(originalName, updatedProduct) {
            // ... (bez zmian) ...
        }
        function handleNewProductSubmit(e) {
            // ... (bez zmian) ...
        }
        function createIngredientRow() {
            // ... (bez zmian) ...
        }
        function initializeComposer(productToEdit = null) {
            // ... (bez zmian) ...
        }
        function updateComposerSummary() {
            // ... (bez zmian) ...
        }
        async function exportToPDF() {
            // ... (bez zmian) ...
        }
        function saveComposedMeal() {
            // ... (bez zmian) ...
        }
        function showMainSuggestions() {
            // ... (bez zmian) ...
        }
        function populateProductListModal() {
            // ... (bez zmian) ...
        }


        // --- NOWE FUNKCJE AI (WERSJA DLA VERCEL) ---

        async function getMealAnalysis(separatorId) {
            const separatorIndex = dailyPlan.findIndex(item => item.id === separatorId);
            if (separatorIndex === -1) {
                showToast("Nie można znaleźć posiłku.");
                return;
            }

            const mealName = dailyPlan[separatorIndex].name || `Posiłek ${separatorIndex + 1}`;
            
            let nextSeparatorIndex = dailyPlan.findIndex((item, index) => index > separatorIndex && item.type === 'separator');
            if (nextSeparatorIndex === -1) {
                nextSeparatorIndex = dailyPlan.length;
            }
            const mealProducts = dailyPlan.slice(separatorIndex + 1, nextSeparatorIndex).filter(item => item.type === 'product');

            if (mealProducts.length === 0) {
                showToast("Posiłek jest pusty. Dodaj produkty, aby go przeanalizować.");
                return;
            }
            
            const mealSummary = calculateMealSummary(mealProducts);
            const mealCount = parseInt(document.getElementById('meal-count').value, 10) || 4;
            const perMealGoals = {
                calories: (dietGoals.calories / mealCount).toFixed(0),
                protein: (dietGoals.protein / mealCount).toFixed(1),
                carbs: (dietGoals.carbs / mealCount).toFixed(1),
                fat: (dietGoals.fat / mealCount).toFixed(1)
            };
            
            aiResponseContent.innerHTML = '';
            aiLoadingState.classList.remove('hidden');
            aiAssistantModal.classList.remove('hidden');
            
            const systemPrompt = `Jesteś "Architektem Posiłków", ekspertem od żywienia w kulturystyce. Twoim zadaniem jest analiza posiłku użytkownika pod kątem hipertrofii. Bądź zwięzły, merytoryczny i motywujący. Używaj Markdown do formatowania. Zawsze zwracaj się do użytkownika po imieniu, ${userNameInput.value.trim()}. Skup się na progu leucynowym (ok. 30-40g białka na posiłek).`;

            const userQuery = `
                Tomku, analizuję Twój "${mealName}".

                Twoje cele na ten posiłek (1 z ${mealCount}) to około:
                - Kalorie: ${perMealGoals.calories} kcal
                - Białko: ${perMealGoals.protein} g
                - Węglowodany: ${perMealGoals.carbs} g
                - Tłuszcze: ${perMealGoals.fat} g

                Aktualna zawartość tego posiłku:
                - Kalorie: ${mealSummary.calories.toFixed(0)} kcal
                - Białko: ${mealSummary.protein.toFixed(1)} g
                - Węglowodany: ${mealSummary.carbs.toFixed(1)} g
                - Tłuszcze: ${mealSummary.fat.toFixed(1)} g

                Produkty w posiłku:
                ${mealProducts.map(p => `- ${p.name} (${p.amount} ${p.displayUnit})`).join('\n')}

                Przeanalizuj ten posiłek. Wskaż mocne strony (np. czy osiągnięto próg leucynowy) oraz zasugeruj 1-2 konkretne zmiany (np. "dodaj 50g ryżu" lub "zamień X na Y"), aby lepiej zbilansować go pod kątem celu. Bądź bardzo konkretny w sugestiach.
            `;
            
            try {
                // *** TO JEST KLUCZOWA ZMIANA ***
                // Ta funkcja łączy się teraz z /api/ai
                const aiText = await callGeminiApiVercel(userQuery, systemPrompt);
                aiResponseContent.innerHTML = window.marked.parse(aiText);
            } catch (error) {
                console.error("Błąd Asystenta AI:", error);
                // *** ZMIANA: Wyświetlamy treść błędu z Vercel/Google ***
                aiResponseContent.innerHTML = `<p class="text-red-400">Wystąpił błąd podczas analizy. Spróbuj ponownie później.</p><p class="text-xs text-gray-500">${error.message}</p>`;
            } finally {
                aiLoadingState.classList.add('hidden');
            }
        }
        
        /**
         * Funkcja łączy się z naszym własnym backendem /api/ai na Vercel.
         */
        async function callGeminiApiVercel(userQuery, systemPrompt) {
            const apiUrl = '/api/ai'; 

            const payload = {
                userQuery: userQuery,
                systemPrompt: systemPrompt
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // *** TO JEST MIEJSCE, GDZIE POWSTAJE BŁĄD ***
            // Jeśli Vercel zwróci 404 (nie ma funkcji) lub 500 (funkcja ma błąd)
            // lub Google zwróci błąd, ten warunek rzuci błędem.
            if (!response.ok) {
                const errorData = await response.json();
                console.error("Błąd funkcji serwerowej (/api/ai):", errorData);
                // Przekazujemy treść błędu (np. "unregistered callers") do bloku catch
                throw new Error(errorData.details || errorData.error || `Błąd serwera: ${response.status}`);
            }

            const result = await response.json();

            if (result && result.text) {
                return result.text;
            } else {
                console.error("Nieprawidłowa struktura odpowiedzi z /api/ai:", result);
                throw new Error("Otrzymano nieprawidłową odpowiedź od Asystenta AI.");
            }
        }
        
        // --- INICJALIZACJA ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- PRZYPISANIE ELEMENTÓW DOM ---
            // Ten kod uruchomi się DOPIERO gdy cały HTML będzie gotowy
            calculateBtn = document.getElementById('calculate-btn');
            editDataBtn = document.getElementById('edit-data-btn');
            clearDataBtn = document.getElementById('clear-day-btn');
            addProductBtn = document.getElementById('add-product-btn');
            productSearchInput = document.getElementById('product-search');
            productSuggestionsContainer = document.getElementById('product-suggestions');
            resultsSection = document.getElementById('results');
            plannerSection = document.getElementById('diet-planner');
            principlesSection = document.getElementById('key-principles');
            supplementationSection = document.getElementById('supplementation');
            hydrationSection = document.getElementById('hydration');
            exportPdfBtn = document.getElementById('export-pdf-btn');
            clearDayBtn = document.getElementById('clear-day-btn');
            addMealSeparatorBtn = document.getElementById('add-meal-separator-btn');
            userNameInput = document.getElementById('user-name');
            userNameDisplay = document.getElementById('user-name-display');
            allDataInputs = [
                document.getElementById('user-name'),
                document.getElementById('gender'),
                document.getElementById('age'),
                document.getElementById('height'),
                document.getElementById('weight'),
                document.getElementById('activity'),
                document.getElementById('goal'),
                document.getElementById('meal-count') 
            ];
            openModalBtn = document.getElementById('open-modal-btn');
            closeModalBtn = document.getElementById('close-modal-btn');
            customProductModal = document.getElementById('custom-product-modal');
            customProductForm = document.getElementById('custom-product-form');
            simpleProductModalTitle = document.getElementById('simple-product-modal-title');
            simpleProductSubmitBtn = document.getElementById('simple-product-submit-btn');
            originalProductNameInput = document.getElementById('original-product-name');
            openComposerBtn = document.getElementById('open-composer-btn');
            closeComposerBtn = document.getElementById('close-composer-btn');
            mealComposerModal = document.getElementById('meal-composer-modal');
            composerIngredientsContainer = document.getElementById('composer-ingredients-container');
            composerSummaryDiv = document.getElementById('composer-summary');
            saveComposedMealBtn = document.getElementById('save-composed-meal-btn');
            showProductListBtn = document.getElementById('show-product-list-btn');
            productListModal = document.getElementById('product-list-modal');
            closeProductListBtn = document.getElementById('close-product-list-btn');
            modalProductListContent = document.getElementById('modal-product-list-content');
            aiAssistantModal = document.getElementById('ai-assistant-modal');
            closeAiModalBtn = document.getElementById('close-ai-modal-btn');
            aiResponseContainer = document.getElementById('ai-response-container');
            aiLoadingState = document.getElementById('ai-loading-state');
            aiResponseContent = document.getElementById('ai-response-content');


            // --- DODAWANIE LISTENERÓW ---
            loadCustomProducts(); 
            loadDailyPlan();
            loadUserData();
            renderMealList();
            updateSummary(); 

            // Sprawdzamy, czy elementy istnieją, zanim dodamy listenery
            if (calculateBtn) calculateBtn.addEventListener('click', calculateNeeds);
            if (editDataBtn) editDataBtn.addEventListener('click', () => {
                document.getElementById('user-data').classList.remove('hidden');
                document.getElementById('user-profile').classList.add('hidden');
                resultsSection.classList.add('hidden');
                plannerSection.classList.add('hidden');
                principlesSection.classList.add('hidden');
                supplementationSection.classList.add('hidden');
                hydrationSection.classList.add('hidden');
            });
            if (clearDataBtn) clearDataBtn.addEventListener('click', clearDailyPlan);
            if (clearDayBtn) clearDayBtn.addEventListener('click', clearDailyPlan);
            if (addMealSeparatorBtn) addMealSeparatorBtn.addEventListener('click', addMealSeparator);
            if (addProductBtn) addProductBtn.addEventListener('click', addProductToPlan);
            if (exportPdfBtn) exportPdfBtn.addEventListener('click', exportToPDF);
            
            const mealListDiv = document.getElementById('meal-list');
            if (mealListDiv) {
                mealListDiv.addEventListener('click', handleMealListClick);
                mealListDiv.addEventListener('input', handleAmountChange);
                mealListDiv.addEventListener('input', handleMealNameChange);
            }

            if (productSearchInput) productSearchInput.addEventListener('input', showMainSuggestions);
            
            document.querySelectorAll('.accordion-container').forEach(container => {
                container.addEventListener('click', handleAccordionClick);
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.relative')) {
                    document.querySelectorAll('.suggestions-container').forEach(c => c.classList.add('hidden'));
                }
            });

            if (openModalBtn) openModalBtn.addEventListener('click', () => {
                resetSimpleProductModal();
                populateCategoryDropdown();
                if (customProductModal) customProductModal.classList.remove('hidden')
            });
            if (closeModalBtn) closeModalBtn.addEventListener('click', () => {
                 if (customProductModal) customProductModal.classList.add('hidden');
                 resetSimpleProductModal();
            });
            if (customProductModal) customProductModal.addEventListener('click', (e) => {
                if (e.target.id === 'custom-product-modal') {
                    customProductModal.classList.add('hidden');
                    resetSimpleProductModal();
                }
            });
            if (customProductForm) customProductForm.addEventListener('submit', handleNewProductSubmit);
            
            const newCategorySelect = document.getElementById('new-product-category');
            if (newCategorySelect) newCategorySelect.addEventListener('change', (e) => {
                const newCategoryWrapper = document.getElementById('new-category-wrapper');
                if (newCategoryWrapper) {
                    if (e.target.value === '__new__') {
                        newCategoryWrapper.classList.remove('hidden');
                    } else {
                        newCategoryWrapper.classList.add('hidden');
                    }
                }
            });

            if (openComposerBtn) openComposerBtn.addEventListener('click', () => {
                initializeComposer();
                if (mealComposerModal) mealComposerModal.classList.remove('hidden');
            });
            if (closeComposerBtn) closeComposerBtn.addEventListener('click', () => {
                if (mealComposerModal) mealComposerModal.classList.add('hidden');
            });
            if (mealComposerModal) mealComposerModal.addEventListener('click', (e) => {
                if (e.target.id === 'meal-composer-modal') {
                    mealComposerModal.classList.add('hidden');
                }
            });
            if (saveComposedMealBtn) saveComposedMealBtn.addEventListener('click', saveComposedMeal);

            if (showProductListBtn) showProductListBtn.addEventListener('click', () => {
                populateProductListModal(); 
                if (productListModal) productListModal.classList.remove('hidden');
            });
            if (closeProductListBtn) closeProductListBtn.addEventListener('click', () => {
                if (productListModal) productListModal.classList.add('hidden');
            });
            if (productListModal) productListModal.addEventListener('click', (e) => {
                if (e.target.id === 'product-list-modal') {
                    productListModal.classList.add('hidden');
                }
            });

            // NOWE: Event Listeners dla modala AI
            // ***** POCZĄTEK POPRAWKI: Uproszczona i bardziej niezawodna logika zamykania *****
            
            const modalToClose = document.getElementById('ai-assistant-modal');

            if (modalToClose) {
                modalToClose.addEventListener('click', (e) => {
                    // Sprawdzamy, czy kliknięto bezpośrednio tło modala (e.target.id)
                    // LUB czy kliknięto przycisk "X" (lub cokolwiek wewnątrz niego - e.target.closest)
                    if (e.target.id === 'ai-assistant-modal' || e.target.closest('#close-ai-modal-btn')) {
                        modalToClose.classList.add('hidden');
                    }
                });
            } else {
                console.error("Nie można znaleźć modala AI o ID 'ai-assistant-modal'.");
            }
            
            // ***** KONIEC POPRAWKI *****
            
            // Upewniamy się, że modalProductListContent nie jest null
            if (modalProductListContent) {
                modalProductListContent.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-custom-product-btn');
                    const editComposedBtn = e.target.closest('.edit-composed-meal-btn');
                    const editSimpleBtn = e.target.closest('.edit-simple-product-btn');
                    const productBtn = e.target.closest('button[data-product-name]');
                    const header = e.target.closest('.product-category-header');
                    
                    // --- 1. Akcja Usuwania ---
                    if (deleteBtn) {
                        e.stopPropagation();
                        const productName = deleteBtn.dataset.productNameToDelete;
                        const originalLength = dailyPlan.length;
                        dailyPlan = dailyPlan.filter(item => item.name !== productName);
                        const itemsRemoved = originalLength > dailyPlan.length;
                        if (itemsRemoved) {
                            saveDailyPlan();
                        }
                        const indexInCustom = customProducts.findIndex(p => p.name === productName);
                        if (indexInCustom > -1) {
                            customProducts.splice(indexInCustom, 1);
                        }
                        saveCustomProducts(); 
                        populateProductListModal(); 
                        showToast(`Produkt "${productName}" został usunięty.`, 'success');
                        if (itemsRemoved) {
                            renderMealList();
                            updateSummary();
                        }
                        return;
                    }

                    // --- 2. Akcja Edycji Posiłku Skomponowanego ---
                    if (editComposedBtn) {
                        e.stopPropagation();
                        const productName = editComposedBtn.dataset.productName;
                        const productToEdit = customProducts.find(p => p.name === productName);
                        if (productToEdit) {
                            initializeComposer(productToEdit);
                            mealComposerModal.classList.remove('hidden');
                            productListModal.classList.add('hidden');
                        }
                        return;
                    }
                    
                    // --- 3. (ZMODYFIKOWANA) Akcja Edycji Produktu Prostego ---
                    if (editSimpleBtn) {
                        e.stopPropagation();
                        const productName = editSimpleBtn.dataset.productName;
                        const productToEdit = foodProducts.find(p => p.name === productName); 
                        if (productToEdit) {
                            openSimpleProductModalForEdit(productToEdit); 
                            productListModal.classList.add('hidden');
                        }
                        return;
                    }

                    // --- 4. Akcja Wyboru Produktu ---
                    if (productBtn) {
                        const productName = productBtn.dataset.productName;
                        const product = foodProducts.find(p => p.name === productName);
                        if (product) {
                            if (activeComposerInput) {
                                activeComposerInput.value = product.name;
                                activeComposerInput.dataset.selectedProduct = JSON.stringify(product);
                                updateComposerSummary();
                                productListModal.classList.add('hidden');
                                activeComposerInput = null;
                            } else {
                                productSearchInput.value = product.name;
                                currentlySelectedProduct = product;
                                productListModal.classList.add('hidden');
                                const amountInput = document.getElementById('product-amount');
                                if (product.isComposed) {
                                    amountInput.placeholder = 'Ilość (porcji)';
                                } else if (product.unit === 'szt') {
                                    amountInput.placeholder = 'Ilość (szt.)';
                                } else {
                                    amountInput.placeholder = 'Ilość (g)';
                                }
                                amountInput.focus();
                            }
                        }
                    }

                    // --- 5. Akcja Zwijania/Rozwijania Kategorii ---
                    if (header) {
                        const contentId = header.dataset.targetId;
                        const content = document.getElementById(contentId);
                        if (content) {
                            if (content.style.maxHeight) {
                                content.style.maxHeight = null;
                                header.classList.add('collapsed');
                            } else {
                                content.style.maxHeight = content.scrollHeight + "px";
                                header.classList.remove('collapsed');
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
